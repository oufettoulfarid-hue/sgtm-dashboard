<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGTM - Tableau de Bord Travaux</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Page de connexion */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        .login-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            border: 2px solid #ffd700;
            text-align: center;
            min-width: 400px;
        }

        .login-title {
            color: #ffd700;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 900;
        }

        .login-subtitle {
            color: #ccc;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .login-input {
            padding: 1rem;
            border: 2px solid #444;
            border-radius: 10px;
            background: #1a1a1a;
            color: white;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }

        .login-btn {
            padding: 1rem;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a1a1a;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .error-message {
            color: #ff4444;
            margin-top: 1rem;
            font-weight: 600;
        }

        /* Dashboard styles */
        .header {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a1a1a;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .user-info {
            float: right;
            background: rgba(26, 26, 26, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 5px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .controls {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
            border-left: 5px solid #ffd700;
        }

        .controls h2 {
            color: #ffd700;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffd700;
        }

        .form-group input, .form-group select {
            padding: 0.75rem;
            border: 2px solid #444;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #1a1a1a;
            color: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a1a1a;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: #ffd700;
            border: 2px solid #ffd700;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .charts-main-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .troncons-container {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            overflow: hidden;
            border-left: 5px solid #ffd700;
        }

        .chart-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border-left: 5px solid #ffd700;
            height: 400px;
        }

        .chart-card h3 {
            color: #ffd700;
            margin-bottom: 1rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .troncon-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            margin: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            overflow: hidden;
            border: 2px solid #ffd700;
            transition: all 0.3s ease;
        }

        .troncon-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }

        .troncon-header {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a1a1a;
            padding: 1rem 1.5rem;
            font-weight: 700;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .activities-table {
            width: 100%;
            border-collapse: collapse;
        }

        .activities-table th {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffd700;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 3px solid #ffd700;
        }

        .activities-table th i {
            margin-right: 0.5rem;
        }

        .activities-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
            transition: background-color 0.3s ease;
        }

        .activities-table tr:hover td {
            background-color: #fff3cd;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
            border-radius: 10px;
            transition: width 0.8s ease;
            position: relative;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 600;
            font-size: 0.8rem;
            color: #1a1a1a;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            border-top: 4px solid #ffd700;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .stat-label {
            color: #ccc;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            border: 2px solid #ffd700;
            animation: modalSlideIn 0.3s ease;
        }

        .modal-content label {
            color: #ffd700;
        }

        .modal-content input {
            background: #1a1a1a;
            color: white;
            border: 2px solid #444;
        }

        .modal-content input:focus {
            border-color: #ffd700;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close {
            color: #ffd700;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #ffed4e;
        }

        .actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .edit-btn, .delete-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .edit-btn {
            background: #ffd700;
            color: #1a1a1a;
        }

        .edit-btn:hover {
            background: #ffed4e;
            transform: scale(1.05);
        }

        .delete-btn {
            background: #ff4444;
            color: white;
        }

        .delete-btn:hover {
            background: #cc0000;
            transform: scale(1.05);
        }

        .quick-actions {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #1a1a1a;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .quick-actions h3 {
            margin-bottom: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-section {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
            border-left: 5px solid #ffd700;
        }

        .export-section h3 {
            color: #ffd700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .daily-input {
            background: #ffd700 !important;
            color: #1a1a1a !important;
            font-weight: 600;
            border: 2px solid #ffed4e !important;
        }

        .daily-input:focus {
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3) !important;
        }

        .linear-charts-section {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
            border-left: 5px solid #ffd700;
        }

        .linear-charts-section h3 {
            color: #ffd700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .linear-chart-container {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            height: 350px;
        }

        .date-filter {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border-left: 5px solid #ffd700;
        }

        .date-filter h3 {
            color: #ffd700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }

        .hidden {
            display: none !important;
        }

        .logo {
            display: inline-block;
            font-size: 1.5rem;
            font-weight: 900;
            color: #1a1a1a;
            margin-right: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .charts-main-container {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 1rem;
            }

            .login-card {
                min-width: 300px;
                margin: 1rem;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .activity-icon {
            width: 20px;
            text-align: center;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Page de connexion -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h1 class="login-title"><i class="fas fa-hard-hat"></i> SGTM</h1>
            <p class="login-subtitle">Tableau de Bord - Suivi des Travaux</p>
            <form id="loginForm" class="login-form">
                <input type="text" id="username" class="login-input" placeholder="üë§ Nom d'utilisateur" required>
                <input type="password" id="accessCode" class="login-input" placeholder="üîí Code d'acc√®s" required>
                <button type="submit" class="login-btn"><i class="fas fa-sign-in-alt"></i> Se connecter</button>
                <div id="loginError" class="error-message" style="display: none;"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard principal -->
    <div id="dashboard" class="hidden">
        <div class="header">
            <div class="container">
                <div class="user-info">
                    <i class="fas fa-user"></i> Utilisateur: <span id="currentUser"></span>
                    <button onclick="logout()" style="margin-left: 1rem; padding: 0.3rem 0.8rem; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-sign-out-alt"></i> D√©connexion
                    </button>
                </div>
                <h1><span class="logo"><i class="fas fa-hard-hat"></i> SGTM</span>Tableau de Bord - Suivi des Travaux</h1>
                <p><i class="fas fa-calendar-day"></i> Gestion journali√®re des tron√ßons et activit√©s de terrassement</p>
            </div>
        </div>

        <div class="container">
            <!-- Indicateur d'auto-sauvegarde -->
            <div id="autoSaveIndicator" class="auto-save-indicator">
                <i class="fas fa-save"></i> Donn√©es sauvegard√©es automatiquement
            </div>

            <!-- Filtre par date -->
            <div class="date-filter">
                <h3><i class="fas fa-calendar-alt"></i> Filtre par date</h3>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <label style="color: #ffd700;"><i class="fas fa-calendar-week"></i> Date de d√©but:</label>
                    <input type="date" id="startDate" style="padding: 0.5rem; border-radius: 5px; border: 1px solid #444; background: #1a1a1a; color: white;">
                    <label style="color: #ffd700;"><i class="fas fa-calendar-week"></i> Date de fin:</label>
                    <input type="date" id="endDate" style="padding: 0.5rem; border-radius: 5px; border: 1px solid #444; background: #1a1a1a; color: white;">
                    <button onclick="filterByDate()" class="btn btn-primary"><i class="fas fa-filter"></i> Filtrer</button>
                    <button onclick="clearDateFilter()" class="btn btn-secondary"><i class="fas fa-times"></i> Effacer</button>
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="quick-actions">
                <h3><i class="fas fa-bolt"></i> Actions Rapides</h3>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="addNewTroncon()"><i class="fas fa-plus"></i> Nouveau Tron√ßon</button>
                    <button class="btn btn-secondary" onclick="showDailyReport()"><i class="fas fa-file-alt"></i> Rapport Journalier</button>
                    <button class="btn btn-secondary" onclick="resetData()"><i class="fas fa-redo"></i> R√©initialiser</button>
                </div>
            </div>

            <!-- Statistiques g√©n√©rales -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value"><i class="fas fa-road"></i> <span id="totalTroncons">0</span></div>
                    <div class="stat-label">Tron√ßons Actifs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><i class="fas fa-excavator"></i> <span id="globalTerrassement">0%</span></div>
                    <div class="stat-label">Terrassement Global</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><i class="fas fa-tools"></i> <span id="globalPose">0%</span></div>
                    <div class="stat-label">Pose Global</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><i class="fas fa-truck"></i> <span id="globalLivraison">0%</span></div>
                    <div class="stat-label">Livraison Global</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><i class="fas fa-layer-group"></i> <span id="globalLitPose">0%</span></div>
                    <div class="stat-label">Lit de Pose Global</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><i class="fas fa-fill"></i> <span id="globalRP">0%</span></div>
                    <div class="stat-label">RP Global</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value"><i class="fas fa-road"></i> <span id="globalRS">0%</span></div>
                    <div class="stat-label">RS Global</div>
                </div>
            </div>

            <!-- Section exportation -->
            <div class="export-section">
                <h3><i class="fas fa-download"></i> Export des Donn√©es</h3>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export Excel</button>
                    <button class="btn btn-primary" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Export PDF</button>
                    <button class="btn btn-secondary" onclick="saveToDatabase()"><i class="fas fa-save"></i> Sauvegarder</button>
                    <button class="btn btn-secondary" onclick="loadFromDatabase()"><i class="fas fa-folder-open"></i> Charger</button>
                </div>
            </div>

            <!-- Contr√¥les -->
            <div class="controls">
                <h2><i class="fas fa-plus-circle"></i> Ajouter un Avancement Journalier</h2>
                <form id="progressForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tronconSelect"><i class="fas fa-road"></i> Tron√ßon</label>
                            <select id="tronconSelect" required>
                                <option value="">S√©lectionner un tron√ßon</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="activitySelect"><i class="fas fa-tasks"></i> Activit√©</label>
                            <select id="activitySelect" required>
                                <option value="">S√©lectionner une activit√©</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dailyProgress"><i class="fas fa-ruler"></i> Avancement du jour (ml)</label>
                            <input type="number" id="dailyProgress" step="0.1" min="0" placeholder="Quantit√© en ml (0 accept√©)" required>
                        </div>
                        <div class="form-group">
                            <label for="date"><i class="fas fa-calendar"></i> Date</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter l'Avancement</button>
                    </div>
                </form>
            </div>

            <!-- Graphiques principaux -->
            <div class="charts-main-container">
                <div class="chart-card">
                    <h3><i class="fas fa-chart-bar"></i> Avancement Global - Tous les Tron√ßons</h3>
                    <canvas id="globalChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Section graphiques lin√©aires -->
            <div class="linear-charts-section">
                <h3><i class="fas fa-chart-line"></i> √âvolution Temporelle par Tron√ßon</h3>
                <div style="margin-bottom: 1rem;">
                    <select id="tronconChartSelect" style="padding: 0.5rem; border-radius: 5px; background: #1a1a1a; color: white; border: 1px solid #ffd700;">
                        <option value="">S√©lectionner un tron√ßon</option>
                    </select>
                    <select id="activityChartSelect" style="padding: 0.5rem; border-radius: 5px; background: #1a1a1a; color: white; border: 1px solid #ffd700; margin-left: 1rem;">
                        <option value="">Toutes les activit√©s</option>
                    </select>
                </div>
                <div id="linearChartContainer" class="linear-chart-container" style="display: none;">
                    <canvas id="linearChart"></canvas>
                </div>
            </div>

            <!-- Tableau des tron√ßons -->
            <div class="dashboard-grid">
                <div class="troncons-container">
                    <div id="tronconsList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour √©dition -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="color: #ffd700; margin-bottom: 1.5rem;"><i class="fas fa-edit"></i> Modifier l'Activit√©</h2>
            <form id="editForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editActivity"><i class="fas fa-tag"></i> Activit√©</label>
                        <input type="text" id="editActivity" readonly>
                    </div>
                    <div class="form-group">
                        <label for="editCumul"><i class="fas fa-chart-line"></i> Cumul Total (ml)</label>
                        <input type="number" id="editCumul" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="editTarget"><i class="fas fa-bullseye"></i> Objectif (ml)</label>
                        <input type="number" id="editTarget" step="0.1" required>
                    </div>
                </div>
                <div class="actions">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Sauvegarder</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()"><i class="fas fa-times"></i> Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration des utilisateurs autoris√©s
        const authorizedUsers = {
            'troncon12': 'KhFa1212',
            'directeur': 'Ahmed El jami',
            'Troncon3': 'Abdo3',
            'Troncon4': 'Badr4'
        };

        // Donn√©es initiales par d√©faut
        const defaultTroncons = {
            'Tron√ßon 1': {
                longueur: '4.2KM',
                distanceTotale: 4258,
                activities: {
                    'terrassement': { cumul: 3918.55, target: 4258, unit: 'ml' },
                    'Livraison conduite': { cumul: 0, target: 4258, unit: 'ml' },
                    'pose conduite': { cumul: 0, target: 4258, unit: 'ml' },
                    'lit de pose': { cumul: 0, target: 4258, unit: 'ml' },
                    'RP': { cumul: 0, target: 4258, unit: 'ml' },
                    'RS': { cumul: 0, target: 4258, unit: 'ml' }
                }
            },
            'Tron√ßon 2': {
                longueur: '24KM',
                distanceTotale: 23940,
                activities: {
                    'terrassement': { cumul: 23940, target: 23940, unit: 'ml' },
                    'Livraison conduite': { cumul: 16094, target: 23940, unit: 'ml' },
                    'pose conduite': { cumul: 15391, target: 23940, unit: 'ml' },
                    'lit de pose': { cumul: 17084, target: 23940, unit: 'ml' },
                    'RP': { cumul: 11937, target: 23940, unit: 'ml' },
                    'RS': { cumul: 11605, target: 23940, unit: 'ml' }
                }
            },
            'Tron√ßon 3': {
                longueur: '11.9KM',
                distanceTotale: 11873,
                activities: {
                    'terrassement': { cumul: 8072, target: 11873, unit: 'ml' },
                    'Livraison conduite': { cumul: 3392.4, target: 11873, unit: 'ml' },
                    'pose conduite': { cumul: 1943, target: 11873, unit: 'ml' },
                    'lit de pose': { cumul: 1975, target: 11873, unit: 'ml' },
                    'RP': { cumul: 0, target: 11873, unit: 'ml' },
                    'RS': { cumul: 0, target: 11873, unit: 'ml' }
                }
            },
            'Tron√ßon 4': {
                longueur: '7.5KM',
                distanceTotale: 7614,
                activities: {
                    'terrassement': { cumul: 6373.6, target: 7614, unit: 'ml' },
                    'Livraison conduite': { cumul: 7563.6, target: 7614, unit: 'ml' },
                    'pose conduite': { cumul: 4514.4, target: 7614, unit: 'ml' },
                    'lit de pose': { cumul: 4728, target: 7614, unit: 'ml' },
                    'RP': { cumul: 0, target: 7614, unit: 'ml' },
                    'RS': { cumul: 0, target: 7614, unit: 'ml' }
                }
            }
        };

        // Variables globales
        let troncons = {};
        let dailyHistory = [];
        let editingTroncon = null;
        let editingActivity = null;
        let charts = {};
        let currentUser = '';
        let dateFilter = null;

        // Fonction pour r√©cup√©rer la valeur initiale d'une activit√©
        function getInitialValue(troncon, activity) {
            if (defaultTroncons[troncon] && defaultTroncons[troncon].activities[activity]) {
                return defaultTroncons[troncon].activities[activity].cumul;
            }
            return 0;
        }

        // Fonction pour recalculer tous les cumuls bas√©s sur les valeurs initiales + historique
        function recalculateAllCumuls() {
            Object.keys(troncons).forEach(tronconName => {
                Object.keys(troncons[tronconName].activities).forEach(activityName => {
                    const initialValue = getInitialValue(tronconName, activityName);
                    const totalFromHistory = dailyHistory
                        .filter(entry => entry.troncon === tronconName && entry.activity === activityName)
                        .reduce((sum, entry) => sum + entry.dailyProgress, 0);
                    
                    troncons[tronconName].activities[activityName].cumul = initialValue + totalFromHistory;
                });
            });
        }

        // Fonction d'initialisation des donn√©es
        function initializeData() {
            // Essayer de charger les donn√©es sauvegard√©es
            const savedData = localStorage.getItem('sgtm_data');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    dailyHistory = parsedData.dailyHistory || [];
                    
                    // Toujours partir des donn√©es par d√©faut et recalculer avec l'historique
                    troncons = JSON.parse(JSON.stringify(defaultTroncons));
                    recalculateAllCumuls();
                    
                    // V√©rifier et corriger les donn√©es apr√®s chargement
                    checkAndFixData();
                    
                } catch (error) {
                    console.error('Erreur lors du chargement des donn√©es:', error);
                    troncons = JSON.parse(JSON.stringify(defaultTroncons));
                    dailyHistory = [];
                }
            } else {
                // Pas de donn√©es sauvegard√©es, utiliser les defaults
                troncons = JSON.parse(JSON.stringify(defaultTroncons));
                dailyHistory = [];
            }
        }

        // Syst√®me d'authentification
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const accessCode = document.getElementById('accessCode').value.trim();
            
            if (authorizedUsers[username] && authorizedUsers[username] === accessCode) {
                currentUser = username;
                localStorage.setItem('sgtm_current_user', username);
                document.getElementById('currentUser').textContent = username;
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Initialiser les donn√©es APR√àS la connexion
                initializeData();
                initializeDateInput();
                populateTronconSelect();
                renderTroncons();
                updateStats();
                createAllCharts();
                showNotification('Connexion r√©ussie!');
            } else {
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = 'Nom d\'utilisateur ou code d\'acc√®s incorrect';
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        });

        function logout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter?')) {
                // Sauvegarder avant de d√©connecter
                saveToDatabase();
                currentUser = '';
                localStorage.removeItem('sgtm_current_user');
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('loginForm').reset();
            }
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // V√©rifier si l'utilisateur est d√©j√† connect√©
            const savedUser = localStorage.getItem('sgtm_current_user');
            if (savedUser) {
                currentUser = savedUser;
                document.getElementById('currentUser').textContent = savedUser;
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Initialiser les donn√©es
                initializeData();
                initializeDateInput();
                populateTronconSelect();
                renderTroncons();
                updateStats();
                createAllCharts();
            }
        });

        function initializeDateInput() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('endDate').value = today;
            
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            document.getElementById('startDate').value = oneWeekAgo.toISOString().split('T')[0];
        }

        function populateTronconSelect() {
            const select = document.getElementById('tronconSelect');
            const chartSelect = document.getElementById('tronconChartSelect');
            
            select.innerHTML = '<option value="">S√©lectionner un tron√ßon</option>';
            chartSelect.innerHTML = '<option value="">S√©lectionner un tron√ßon</option>';
            
            Object.keys(troncons).forEach(troncon => {
                const option = document.createElement('option');
                option.value = troncon;
                option.textContent = `${troncon} (${troncons[troncon].longueur})`;
                select.appendChild(option);
                
                const chartOption = option.cloneNode(true);
                chartSelect.appendChild(chartOption);
            });
        }

        // Function pour obtenir l'ic√¥ne d'activit√©
        function getActivityIcon(activity) {
            const icons = {
                'terrassement': 'fas fa-excavator',
                'pose conduite': 'fas fa-tools',
                'Livraison conduite': 'fas fa-truck',
                'livraison conduite': 'fas fa-truck',
                'lit de pose': 'fas fa-layer-group',
                'RP': 'fas fa-fill',
                'RS': 'fas fa-road'
            };
            return icons[activity] || 'fas fa-cog';
        }

        document.getElementById('tronconSelect').addEventListener('change', function() {
            const selectedTroncon = this.value;
            const activitySelect = document.getElementById('activitySelect');
            
            activitySelect.innerHTML = '<option value="">S√©lectionner une activit√©</option>';
            
            if (selectedTroncon && troncons[selectedTroncon]) {
                Object.keys(troncons[selectedTroncon].activities).forEach(activity => {
                    const option = document.createElement('option');
                    option.value = activity;
                    option.textContent = activity.charAt(0).toUpperCase() + activity.slice(1);
                    activitySelect.appendChild(option);
                });
            }
        });

        document.getElementById('tronconChartSelect').addEventListener('change', function() {
            const selectedTroncon = this.value;
            const activitySelect = document.getElementById('activityChartSelect');
            
            if (selectedTroncon) {
                // Populate activity select for this troncon
                activitySelect.innerHTML = '<option value="">Toutes les activit√©s</option>';
                Object.keys(troncons[selectedTroncon].activities).forEach(activity => {
                    const option = document.createElement('option');
                    option.value = activity;
                    option.textContent = activity.charAt(0).toUpperCase() + activity.slice(1);
                    activitySelect.appendChild(option);
                });
                
                document.getElementById('linearChartContainer').style.display = 'block';
                createLinearChart(selectedTroncon);
            } else {
                document.getElementById('linearChartContainer').style.display = 'none';
                activitySelect.innerHTML = '<option value="">Toutes les activit√©s</option>';
            }
        });

        document.getElementById('activityChartSelect').addEventListener('change', function() {
            const selectedTroncon = document.getElementById('tronconChartSelect').value;
            if (selectedTroncon) {
                createLinearChart(selectedTroncon, this.value);
            }
        });

        document.getElementById('progressForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const troncon = document.getElementById('tronconSelect').value;
            const activity = document.getElementById('activitySelect').value;
            const dailyProgress = parseFloat(document.getElementById('dailyProgress').value);
            const date = document.getElementById('date').value;
            
            if (!troncon || !activity || dailyProgress === '' || !date) {
                showNotification('Veuillez remplir tous les champs', 'error');
                return;
            }
            
            if (dailyProgress < 0) {
                showNotification('La valeur ne peut pas √™tre n√©gative', 'error');
                return;
            }
            
            // Ajouter √† l'historique
            dailyHistory.push({
                date,
                troncon,
                activity,
                dailyProgress,
                user: currentUser,
                timestamp: new Date().toISOString()
            });
            
            // Mettre √† jour le cumul avec la valeur initiale + historique
            const initialValue = getInitialValue(troncon, activity);
            const totalFromHistory = dailyHistory
                .filter(entry => entry.troncon === troncon && entry.activity === activity)
                .reduce((sum, entry) => sum + entry.dailyProgress, 0);
            
            troncons[troncon].activities[activity].cumul = initialValue + totalFromHistory;
            
            // R√©initialiser le formulaire
            this.reset();
            initializeDateInput();
            document.getElementById('activitySelect').innerHTML = '<option value="">S√©lectionner une activit√©</option>';
            
            // Mettre √† jour l'affichage
            renderTroncons();
            updateStats();
            updateAllCharts();
            autoSave();
            
            showNotification(`Avancement ajout√©: ${formatNumber(dailyProgress)} ml pour ${activity}`);
        });

        function renderTroncons() {
            const container = document.getElementById('tronconsList');
            container.innerHTML = '';
            
            Object.entries(troncons).forEach(([tronconName, tronconData]) => {
                const tronconCard = document.createElement('div');
                tronconCard.className = 'troncon-card';
                
                const header = document.createElement('div');
                header.className = 'troncon-header';
                header.innerHTML = `
                    <i class="fas fa-road"></i> ${tronconName} - ${tronconData.longueur}
                    <button style="float: right; background: #1a1a1a; color: #ffd700; border: 1px solid #ffd700; padding: 0.3rem 0.8rem; border-radius: 5px; cursor: pointer;" 
                            onclick="addNewActivity('${tronconName}')">
                        <i class="fas fa-plus"></i> Activit√©
                    </button>
                `;
                
                const table = document.createElement('table');
                table.className = 'activities-table';
                
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th><i class="fas fa-tasks"></i> Activit√©</th>
                        <th><i class="fas fa-chart-line"></i> Cumul (ml)</th>
                        <th><i class="fas fa-bullseye"></i> Objectif (ml)</th>
                        <th><i class="fas fa-percentage"></i> Rendement</th>
                        <th><i class="fas fa-calendar-day"></i> Avancement Journalier</th>
                        <th><i class="fas fa-cogs"></i> Actions</th>
                    </tr>
                `;
                
                const tbody = document.createElement('tbody');
                
                Object.entries(tronconData.activities).forEach(([activityName, activityData]) => {
                    const percentage = Math.round((activityData.cumul / activityData.target) * 100);
                    const row = document.createElement('tr');
                    
                    // Calculer l'avancement journalier pour aujourd'hui
                    const today = new Date().toISOString().split('T')[0];
                    const todayProgress = dailyHistory
                        .filter(entry => entry.date === today && entry.troncon === tronconName && entry.activity === activityName)
                        .reduce((sum, entry) => sum + entry.dailyProgress, 0);
                    
                    row.innerHTML = `
                        <td style="font-weight: 600; color: #2c3e50;">
                            <span class="activity-icon"><i class="${getActivityIcon(activityName)}"></i></span>
                            ${activityName}
                        </td>
                        <td>${formatNumber(activityData.cumul)} ml</td>
                        <td>${formatNumber(activityData.target)} ml</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${Math.min(percentage, 100)}%">
                                    <div class="progress-text">${percentage}%</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <input type="number" class="daily-input" style="width: 100px; padding: 0.3rem; border-radius: 5px; border: none; text-align: center;" 
                                   min="0" step="0.1" placeholder="0" value="${todayProgress > 0 ? formatNumber(todayProgress) : ''}"
                                   onchange="updateDailyProgress('${tronconName}', '${activityName}', this.value)">
                            <div style="font-size: 0.8rem; color: #666; margin-top: 0.2rem;"><i class="fas fa-ruler"></i> ml/jour</div>
                        </td>
                        <td>
                            <button class="edit-btn" onclick="editActivity('${tronconName}', '${activityName}')">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                            <button class="delete-btn" onclick="deleteActivity('${tronconName}', '${activityName}')">
                                <i class="fas fa-trash"></i> Supprimer
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                table.appendChild(thead);
                table.appendChild(tbody);
                tronconCard.appendChild(header);
                tronconCard.appendChild(table);
                container.appendChild(tronconCard);
            });
        }

        function updateDailyProgress(troncon, activity, value) {
            const today = new Date().toISOString().split('T')[0];
            const dailyProgress = parseFloat(value) || 0;
            
            if (dailyProgress < 0) {
                showNotification('La valeur ne peut pas √™tre n√©gative', 'error');
                renderTroncons();
                return;
            }
            
            // Supprimer les entr√©es existantes pour aujourd'hui
            dailyHistory = dailyHistory.filter(entry => 
                !(entry.date === today && entry.troncon === troncon && entry.activity === activity)
            );
            
            // Ajouter la nouvelle entr√©e si la valeur est positive
            if (dailyProgress > 0) {
                dailyHistory.push({
                    date: today,
                    troncon,
                    activity,
                    dailyProgress,
                    user: currentUser,
                    timestamp: new Date().toISOString()
                });
            }
            
            // Recalculer le cumul : valeur initiale + historique
            const initialValue = getInitialValue(troncon, activity);
            const totalFromHistory = dailyHistory
                .filter(entry => entry.troncon === troncon && entry.activity === activity)
                .reduce((sum, entry) => sum + entry.dailyProgress, 0);
            
            troncons[troncon].activities[activity].cumul = initialValue + totalFromHistory;
            
            updateStats();
            updateAllCharts();
            autoSave();
            
            if (dailyProgress > 0) {
                showNotification(`Avancement journalier mis √† jour: ${formatNumber(dailyProgress)} ml`);
            }
        }

        function updateStats() {
            const totalTroncons = Object.keys(troncons).length;
            
            let totalDistance = 0;
            let totalTerrassement = 0;
            let totalPose = 0;
            let totalLivraison = 0;
            let totalLitPose = 0;
            let totalRP = 0;
            let totalRS = 0;
            
            Object.values(troncons).forEach(troncon => {
                totalDistance += troncon.distanceTotale;
                
                if (troncon.activities.terrassement) {
                    totalTerrassement += troncon.activities.terrassement.cumul;
                }
                
                if (troncon.activities['pose conduite']) {
                    totalPose += troncon.activities['pose conduite'].cumul;
                }
                
                if (troncon.activities['Livraison conduite']) {
                    totalLivraison += troncon.activities['Livraison conduite'].cumul;
                }
                
                if (troncon.activities['lit de pose']) {
                    totalLitPose += troncon.activities['lit de pose'].cumul;
                }
                
                if (troncon.activities['RP']) {
                    totalRP += troncon.activities['RP'].cumul;
                }
                
                if (troncon.activities['RS']) {
                    totalRS += troncon.activities['RS'].cumul;
                }
            });
            
            document.getElementById('totalTroncons').textContent = totalTroncons;
            document.getElementById('globalTerrassement').textContent = totalDistance > 0 ? Math.round((totalTerrassement / totalDistance) * 100) + '%' : '0%';
            document.getElementById('globalPose').textContent = totalDistance > 0 ? Math.round((totalPose / totalDistance) * 100) + '%' : '0%';
            document.getElementById('globalLivraison').textContent = totalDistance > 0 ? Math.round((totalLivraison / totalDistance) * 100) + '%' : '0%';
            document.getElementById('globalLitPose').textContent = totalDistance > 0 ? Math.round((totalLitPose / totalDistance) * 100) + '%' : '0%';
            document.getElementById('globalRP').textContent = totalDistance > 0 ? Math.round((totalRP / totalDistance) * 100) + '%' : '0%';
            document.getElementById('globalRS').textContent = totalDistance > 0 ? Math.round((totalRS / totalDistance) * 100) + '%' : '0%';
        }

        function editActivity(troncon, activity) {
            editingTroncon = troncon;
            editingActivity = activity;
            
            const activityData = troncons[troncon].activities[activity];
            document.getElementById('editActivity').value = activity;
            document.getElementById('editCumul').value = activityData.cumul;
            document.getElementById('editTarget').value = activityData.target;
            
            document.getElementById('editModal').style.display = 'block';
        }

        function deleteActivity(troncon, activity) {
            if (confirm(`√ätes-vous s√ªr de vouloir supprimer l'activit√© "${activity}" du ${troncon}?`)) {
                delete troncons[troncon].activities[activity];
                
                // Supprimer aussi de l'historique
                dailyHistory = dailyHistory.filter(entry => 
                    !(entry.troncon === troncon && entry.activity === activity)
                );
                
                renderTroncons();
                updateStats();
                updateAllCharts();
                autoSave();
            }
        }

        function addNewActivity(troncon) {
            const activityName = prompt('Nom de la nouvelle activit√©:');
            const target = parseFloat(prompt('Objectif (quantit√© totale en ml):'));
            
            if (activityName && target) {
                troncons[troncon].activities[activityName] = {
                    cumul: 0,
                    target: target,
                    unit: 'ml'
                };
                
                renderTroncons();
                updateStats();
                updateAllCharts();
                autoSave();
                showNotification(`Activit√© "${activityName}" ajout√©e avec succ√®s`);
            }
        }

        function addNewTroncon() {
            const name = prompt('Nom du nouveau tron√ßon:');
            const longueur = prompt('Longueur du tron√ßon (ex: 5.2KM):');
            const distanceTotale = parseFloat(prompt('Distance totale (en ml):'));
            
            if (name && longueur && distanceTotale && !isNaN(distanceTotale)) {
                troncons[name] = {
                    longueur: longueur,
                    distanceTotale: distanceTotale,
                    activities: {
                        'terrassement': { cumul: 0, target: distanceTotale, unit: 'ml' }
                    }
                };
                
                populateTronconSelect();
                renderTroncons();
                updateStats();
                updateAllCharts();
                autoSave();
                showNotification(`Tron√ßon "${name}" ajout√© avec succ√®s`);
            } else {
                showNotification('Donn√©es invalides', 'error');
            }
        }

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newCumul = parseFloat(document.getElementById('editCumul').value);
            const newTarget = parseFloat(document.getElementById('editTarget').value);
            
            troncons[editingTroncon].activities[editingActivity].cumul = newCumul;
            troncons[editingTroncon].activities[editingActivity].target = newTarget;
            
            closeModal();
            renderTroncons();
            updateStats();
            updateAllCharts();
            autoSave();
            showNotification('Donn√©es modifi√©es avec succ√®s');
        });

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        document.querySelector('.close').addEventListener('click', closeModal);

        window.addEventListener('click', function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Gestion des graphiques
        function createAllCharts() {
            createGlobalChart();
            createActivityPieChart();
        }

        function createGlobalChart() {
            const ctx = document.getElementById('globalChart').getContext('2d');
            
            if (charts.globalChart) {
                charts.globalChart.destroy();
            }
            
            const allActivities = new Set();
            Object.values(troncons).forEach(tronconData => {
                Object.keys(tronconData.activities).forEach(activity => {
                    allActivities.add(activity);
                });
            });
            
            const activityArray = Array.from(allActivities);
            const tronconNames = Object.keys(troncons);
            
            const activityColors = {
                'terrassement': '#f4a261',
                'pose conduite': '#2a9d8f',
                'Livraison conduite': '#e76f51',
                'lit de pose': '#264653',
                'RP': '#457b9d',
                'RS': '#9c89b8'
            };
            
            const datasets = activityArray.map(activity => {
                const data = tronconNames.map(troncon => {
                    const tronconData = troncons[troncon];
                    if (tronconData.activities[activity]) {
                        return Math.round((tronconData.activities[activity].cumul / tronconData.activities[activity].target) * 100);
                    }
                    return 0;
                });
                
                return {
                    label: activity.charAt(0).toUpperCase() + activity.slice(1),
                    data: data,
                    backgroundColor: activityColors[activity] || '#ffd700',
                    borderColor: '#1a1a1a',
                    borderWidth: 1
                };
            });
            
            charts.globalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tronconNames,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#ffd700',
                                font: {
                                    size: 11
                                },
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#ffd700',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 215, 0, 0.2)'
                            },
                            title: {
                                display: true,
                                text: 'Pourcentage de progression',
                                color: '#ffd700'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffd700'
                            },
                            grid: {
                                color: 'rgba(255, 215, 0, 0.2)'
                            },
                            title: {
                                display: true,
                                text: 'Tron√ßons',
                                color: '#ffd700'
                            }
                        }
                    }
                }
            });
        }

        function createActivityPieChart() {
            // Cette fonction n'est plus utilis√©e car nous n'avons qu'un graphique principal
        }

        function createLinearChart(tronconName, specificActivity = null) {
            const ctx = document.getElementById('linearChart').getContext('2d');
            
            if (charts.linearChart) {
                charts.linearChart.destroy();
            }
            
            if (!troncons[tronconName]) return;
            
            // Filtrer l'historique pour ce tron√ßon
            let filteredHistory = dailyHistory.filter(entry => entry.troncon === tronconName);
            
            // Appliquer le filtre de date si n√©cessaire
            if (dateFilter) {
                filteredHistory = filteredHistory.filter(entry => 
                    entry.date >= dateFilter.start && entry.date <= dateFilter.end
                );
            }
            
            // Filtrer par activit√© sp√©cifique si s√©lectionn√©e
            if (specificActivity) {
                filteredHistory = filteredHistory.filter(entry => entry.activity === specificActivity);
            }
            
            // Obtenir toutes les dates uniques et les trier
            const allDates = [...new Set(filteredHistory.map(entry => entry.date))].sort();
            
            if (allDates.length === 0) {
                // Si pas de donn√©es, cr√©er un graphique avec les donn√©es actuelles
                const tronconData = troncons[tronconName];
                const activities = specificActivity ? [specificActivity] : Object.keys(tronconData.activities);
                
                const activityColors = {
                    'terrassement': '#f4a261',
                    'pose conduite': '#2a9d8f',
                    'Livraison conduite': '#e76f51',
                    'lit de pose': '#264653',
                    'RP': '#457b9d',
                    'RS': '#9c89b8'
                };
                
                const datasets = activities.map(activity => {
                    const currentValue = tronconData.activities[activity] ? tronconData.activities[activity].cumul : 0;
                    return {
                        label: activity,
                        data: [currentValue],
                        borderColor: activityColors[activity] || '#ffd700',
                        backgroundColor: (activityColors[activity] || '#ffd700') + '20',
                        fill: false,
                        tension: 0.1
                    };
                });
                
                charts.linearChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Cumul actuel'],
                        datasets: datasets
                    },
                    options: getLinearChartOptions()
                });
                return;
            }
            
            // Obtenir les activit√©s pour ce tron√ßon
            const activities = specificActivity ? [specificActivity] : Object.keys(troncons[tronconName].activities);
            
            const activityColors = {
                'terrassement': '#f4a261',
                'pose conduite': '#2a9d8f',
                'Livraison conduite': '#e76f51',
                'lit de pose': '#264653',
                'RP': '#457b9d',
                'RS': '#9c89b8'
            };
            
            // Cr√©er les datasets pour chaque activit√©
            const datasets = activities.map(activity => {
                const data = [];
                let cumulativeSum = getInitialValue(tronconName, activity); // Commencer avec la valeur initiale
                
                allDates.forEach(date => {
                    const dayEntries = filteredHistory.filter(entry => 
                        entry.date === date && entry.activity === activity
                    );
                    
                    const dayTotal = dayEntries.reduce((sum, entry) => sum + entry.dailyProgress, 0);
                    cumulativeSum += dayTotal;
                    data.push(cumulativeSum);
                });
                
                return {
                    label: activity,
                    data: data,
                    borderColor: activityColors[activity] || '#ffd700',
                    backgroundColor: (activityColors[activity] || '#ffd700') + '20',
                    fill: false,
                    tension: 0.1,
                    borderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });
            
            charts.linearChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allDates.map(date => {
                        const d = new Date(date);
                        return `${d.getDate()}/${d.getMonth() + 1}`;
                    }),
                    datasets: datasets
                },
                options: getLinearChartOptions()
            });
        }

        function getLinearChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: '#ffd700',
                            font: {
                                size: 11
                            },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${formatNumber(context.parsed.y)} ml`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#ffd700',
                            callback: function(value) {
                                return formatNumber(value) + ' ml';
                            }
                        },
                        grid: {
                            color: 'rgba(255, 215, 0, 0.2)'
                        },
                        title: {
                            display: true,
                            text: 'Cumul des travaux (ml)',
                            color: '#ffd700'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#ffd700',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            color: 'rgba(255, 215, 0, 0.2)'
                        },
                        title: {
                            display: true,
                            text: 'Date',
                            color: '#ffd700'
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            };
        }

        function updateAllCharts() {
            createAllCharts();
            
            // Recr√©er le graphique lin√©aire si un tron√ßon est s√©lectionn√©
            const selectedTroncon = document.getElementById('tronconChartSelect').value;
            const selectedActivity = document.getElementById('activityChartSelect').value;
            if (selectedTroncon) {
                createLinearChart(selectedTroncon, selectedActivity || null);
            }
        }

        // Fonctions de filtrage par date
        function filterByDate() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showNotification('Veuillez s√©lectionner les deux dates', 'error');
                return;
            }
            
            if (startDate > endDate) {
                showNotification('La date de d√©but ne peut pas √™tre sup√©rieure √† la date de fin', 'error');
                return;
            }
            
            dateFilter = { start: startDate, end: endDate };
            
            showNotification(`Filtrage appliqu√© du ${startDate} au ${endDate}`);
            
            // Recr√©er le graphique lin√©aire si un tron√ßon est s√©lectionn√©
            const selectedTroncon = document.getElementById('tronconChartSelect').value;
            const selectedActivity = document.getElementById('activityChartSelect').value;
            if (selectedTroncon) {
                createLinearChart(selectedTroncon, selectedActivity || null);
            }
        }

        function clearDateFilter() {
            dateFilter = null;
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            
            showNotification('Filtre de date supprim√©');
            
            // Recr√©er le graphique lin√©aire si un tron√ßon est s√©lectionn√©
            const selectedTroncon = document.getElementById('tronconChartSelect').value;
            const selectedActivity = document.getElementById('activityChartSelect').value;
            if (selectedTroncon) {
                createLinearChart(selectedTroncon, selectedActivity || null);
            }
        }

        // Fonctions d'export
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Feuille principale - R√©sum√©
            const summaryData = [];
            summaryData.push(['SGTM - Tableau de Bord Travaux']);
            summaryData.push(['Date d\'export:', new Date().toLocaleDateString('fr-FR')]);
            summaryData.push(['Export√© par:', currentUser]);
            summaryData.push([]);
            summaryData.push(['Tron√ßon', 'Longueur', 'Activit√©', 'Cumul (ml)', 'Objectif (ml)', 'Rendement (%)']);
            
            Object.entries(troncons).forEach(([tronconName, tronconData]) => {
                Object.entries(tronconData.activities).forEach(([activityName, activityData]) => {
                    const percentage = Math.round((activityData.cumul / activityData.target) * 100);
                    summaryData.push([
                        tronconName,
                        tronconData.longueur,
                        activityName,
                        activityData.cumul,
                        activityData.target,
                        percentage
                    ]);
                });
            });
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, 'R√©sum√©');
            
            // Feuille historique
            if (dailyHistory.length > 0) {
                const historyData = [['Date', 'Tron√ßon', 'Activit√©', 'Avancement (ml)', 'Utilisateur', 'Timestamp']];
                dailyHistory.forEach(entry => {
                    historyData.push([
                        entry.date, 
                        entry.troncon, 
                        entry.activity, 
                        entry.dailyProgress,
                        entry.user || 'N/A',
                        entry.timestamp || 'N/A'
                    ]);
                });
                
                const ws2 = XLSX.utils.aoa_to_sheet(historyData);
                XLSX.utils.book_append_sheet(wb, ws2, 'Historique');
            }
            
            XLSX.writeFile(wb, `SGTM_Travaux_${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Export Excel r√©ussi!');
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Fonction pour formater les nombres pour le PDF (√©viter les s√©parateurs fran√ßais)
            function formatNumberForPDF(num) {
                return num.toFixed(1).replace(/\.0$/, '');
            }
            
            // En-t√™te avec logo et titre
            doc.setFontSize(24);
            doc.setTextColor(255, 215, 0);
            doc.text('SGTM - Tableau de Bord Travaux', 20, 25);
            
            // Informations d'export
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            const now = new Date();
            const dateStr = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;
            const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            doc.text(`Date d'export: ${dateStr} √† ${timeStr}`, 20, 35);
            doc.text(`Export√© par: ${currentUser}`, 20, 42);
            
            // Ligne de s√©paration
            doc.setDrawColor(255, 215, 0);
            doc.setLineWidth(1);
            doc.line(20, 47, 190, 47);
            
            let startY = 55;
            
            // Couleurs pour les tableaux
            const tableColors = [
                [255, 235, 59],   // Jaune
                [76, 175, 80],    // Vert
                [33, 150, 243],   // Bleu
                [255, 152, 0],    // Orange
                [156, 39, 176],   // Violet
                [244, 67, 54],    // Rouge
                [0, 150, 136]     // Teal
            ];
            
            let colorIndex = 0;
            
            // Cr√©er un tableau pour chaque tron√ßon
            Object.entries(troncons).forEach(([tronconName, tronconData]) => {
                // V√©rifier si on a besoin d'une nouvelle page
                if (startY > 220) {
                    doc.addPage();
                    startY = 20;
                }
                
                // Titre du tron√ßon
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text(`${tronconName} - ${tronconData.longueur}`, 20, startY);
                
                // Donn√©es du tableau
                const tableData = [];
                Object.entries(tronconData.activities).forEach(([activityName, activityData]) => {
                    const percentage = Math.round((activityData.cumul / activityData.target) * 100);
                    tableData.push([
                        activityName,
                        formatNumberForPDF(activityData.cumul) + ' ml',
                        formatNumberForPDF(activityData.target) + ' ml',
                        percentage + '%'
                    ]);
                });
                
                // Couleur pour ce tableau
                const currentColor = tableColors[colorIndex % tableColors.length];
                colorIndex++;
                
                // Cr√©er le tableau
                doc.autoTable({
                    head: [['Activit√©', 'Cumul (ml)', 'Objectif (ml)', 'Rendement (%)']],
                    body: tableData,
                    startY: startY + 5,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: currentColor,
                        textColor: [0, 0, 0],
                        fontStyle: 'bold',
                        fontSize: 11
                    },
                    bodyStyles: {
                        fontSize: 10
                    },
                    alternateRowStyles: { 
                        fillColor: [currentColor[0], currentColor[1], currentColor[2], 0.1]
                    },
                    margin: { left: 20, right: 20 },
                    columnStyles: {
                        0: { cellWidth: 45 },
                        1: { cellWidth: 35, halign: 'right' },
                        2: { cellWidth: 35, halign: 'right' },
                        3: { cellWidth: 25, halign: 'center' }
                    }
                });
                
                startY = doc.lastAutoTable.finalY + 15;
            });
            
            // Ajouter une nouvelle page pour les graphiques
            doc.addPage();
            
            // Titre pour les graphiques
            doc.setFontSize(18);
            doc.setTextColor(255, 215, 0);
            doc.text('Graphiques de Progression', 20, 25);
            
            // Capturer et ajouter le graphique principal
            try {
                const canvas = document.getElementById('globalChart');
                if (canvas) {
                    const canvasImg = canvas.toDataURL('image/png', 1.0);
                    doc.addImage(canvasImg, 'PNG', 20, 35, 170, 100);
                }
            } catch (error) {
                console.error('Erreur lors de la capture du graphique:', error);
                doc.setFontSize(12);
                doc.setTextColor(255, 0, 0);
                doc.text('Erreur: Impossible de capturer le graphique', 20, 80);
            }
            
            // Ajouter le graphique lin√©aire s'il existe
            try {
                const linearCanvas = document.getElementById('linearChart');
                if (linearCanvas && charts.linearChart) {
                    doc.addImage(linearCanvas.toDataURL('image/png', 1.0), 'PNG', 20, 150, 170, 100);
                }
            } catch (error) {
                console.error('Erreur lors de la capture du graphique lin√©aire:', error);
            }
            
            // Ajouter une page pour les statistiques globales
            doc.addPage();
            doc.setFontSize(18);
            doc.setTextColor(255, 215, 0);
            doc.text('Statistiques Globales', 20, 25);
            
            // Cr√©er un tableau de statistiques
            const statsData = [
                ['Nombre total de tron√ßons', document.getElementById('totalTroncons').textContent],
                ['Terrassement global', document.getElementById('globalTerrassement').textContent],
                ['Pose globale', document.getElementById('globalPose').textContent],
                ['Livraison globale', document.getElementById('globalLivraison').textContent],
                ['Lit de pose global', document.getElementById('globalLitPose').textContent],
                ['RP global', document.getElementById('globalRP').textContent],
                ['RS global', document.getElementById('globalRS').textContent]
            ];
            
            doc.autoTable({
                head: [['Indicateur', 'Valeur']],
                body: statsData,
                startY: 35,
                theme: 'grid',
                headStyles: { 
                    fillColor: [63, 81, 181],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    fontSize: 11
                },
                alternateRowStyles: { 
                    fillColor: [245, 245, 245]
                },
                margin: { left: 20, right: 20 },
                columnStyles: {
                    0: { cellWidth: 120 },
                    1: { cellWidth: 50, halign: 'center', fontStyle: 'bold' }
                }
            });
            
            // Footer sur toutes les pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} sur ${pageCount}`, 20, 285);
                doc.text(`G√©n√©r√© par SGTM Dashboard v3.1`, 150, 285);
            }
            
            // Nom du fichier avec date
            const filename = `SGTM_Travaux_${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}.pdf`;
            doc.save(filename);
            
            showNotification('Export PDF r√©ussi avec graphiques!');
        }

        // Fonctions de sauvegarde et chargement
        function saveToDatabase() {
            const dataToSave = {
                troncons: troncons,
                dailyHistory: dailyHistory,
                lastUpdated: new Date().toISOString(),
                updatedBy: currentUser,
                version: '3.1'
            };
            
            localStorage.setItem('sgtm_data', JSON.stringify(dataToSave));
            localStorage.setItem('sgtm_current_user', currentUser);
            
            showNotification('Donn√©es sauvegard√©es avec succ√®s!');
        }

        function loadFromDatabase() {
            const savedData = localStorage.getItem('sgtm_data');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    dailyHistory = parsedData.dailyHistory || [];

                    // Toujours partir des donn√©es par d√©faut et recalculer
                    troncons = JSON.parse(JSON.stringify(defaultTroncons));
                    recalculateAllCumuls();
                    
                    renderTroncons();
                    updateStats();
                    updateAllCharts();
                    populateTronconSelect();
                    showNotification('Donn√©es charg√©es avec succ√®s!');
                } catch (error) {
                    console.error('Erreur lors du chargement des donn√©es:', error);
                    showNotification('Erreur lors du chargement des donn√©es', 'error');
                }
            }
        }

        function showDailyReport() {
            const today = new Date().toISOString().split('T')[0];
            const todayEntries = dailyHistory.filter(entry => entry.date === today);
            
            if (todayEntries.length === 0) {
                showNotification('Aucune activit√© enregistr√©e pour aujourd\'hui', 'error');
                return;
            }
            
            let report = `RAPPORT JOURNALIER - ${today}\n\n`;
            let totalVolume = 0;
            
            const groupedEntries = {};
            todayEntries.forEach(entry => {
                const key = `${entry.troncon} - ${entry.activity}`;
                if (!groupedEntries[key]) {
                    groupedEntries[key] = 0;
                }
                groupedEntries[key] += entry.dailyProgress;
                totalVolume += entry.dailyProgress;
            });
            
            Object.entries(groupedEntries).forEach(([key, value]) => {
                report += `${key}: ${formatNumber(value)} ml\n`;
            });
            
            report += `\nVolume total du jour: ${formatNumber(totalVolume)} ml`;
            report += `\nNombre d'entr√©es: ${todayEntries.length}`;
            alert(report);
        }

        function resetData() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser toutes les donn√©es? Cette action est irr√©versible.')) {
                // R√©initialiser avec les valeurs par d√©faut
                troncons = JSON.parse(JSON.stringify(defaultTroncons));
                dailyHistory = [];
                
                renderTroncons();
                updateStats();
                updateAllCharts();
                populateTronconSelect();
                autoSave();
                showNotification('Donn√©es r√©initialis√©es');
            }
        }

        function formatNumber(num) {
            return num.toLocaleString('fr-FR', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 1
            });
        }

        // Auto-sauvegarde
        function autoSave() {
            saveToDatabase();
            
            // Afficher l'indicateur d'auto-sauvegarde
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // Auto-sauvegarde toutes les 30 secondes
        setInterval(autoSave, 30000);

        // Notifications
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)' : 'linear-gradient(135deg, #ff4444 0%, #cc0000 100%)'};
                color: ${type === 'success' ? '#1a1a1a' : 'white'};
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 1001;
                animation: slideInRight 0.3s ease;
                font-weight: 600;
                max-width: 300px;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            `;
            
            const icon = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-triangle"></i>';
            notification.innerHTML = `${icon} ${message}`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Sauvegarde automatique avant de quitter
        window.addEventListener('beforeunload', function() {
            autoSave();
        });
    </script>
</body>
</html>
